# Basic Pipeline

(The following provides the complete workflow for running Molo Pipeline on various datasets. Copy and run the code to reproduce all results displayed on the website. Additionally, we provide official dataset links & pre-packaged molo objects that users can choose to download as needed.)

## 10X Visium

### Data Requirements

10X Visium data for Molo Pipeline must contain the **filtered_feature_bc_matrix.h5** file and **spatial** folder. The spatial folder should include three files: **scalefactors_json.json**, **tissue_lowres_image.png**, and **tissue_positions_list.csv**. These files are generated by Space Ranger. Below is the file structure tree for example data:

```bash
visium
├── filtered_feature_bc_matrix.h5
└── spatial
    ├── aligned_fiducials.jpg
    ├── detected_tissue_image.jpg
    ├── scalefactors_json.json
    ├── tissue_hires_image.png
    ├── tissue_lowres_image.png
    └── tissue_positions_list.csv
    
```

### Example Data

You can download public [10X Visium data](https://www.10xgenomics.com/datasets/mouse-brain-serial-section-1-sagittal-anterior-1-standard-1-1-0) from here. Molo also supports cell label transfer using reference datasets (optional). For demonstration, we use Seurat-formatted [mouse brain reference data](https://www.dropbox.com/s/cuowvm4vrf65pvq/allen_cortex.rds?dl=1) as an example. Here is the corresponding [paper](https://www.nature.com/articles/nn.4216).

### Standard Pipeline

```R
molo_obj <- create_molo("Visium", folder_path = "./visium")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "mouse",
                          molo_env = "/anaconda3/envs/Molo/",
                          plot_path = "./plots/visium/",
                          labeled_ref = "./ref/mouse_brain.rds",
                          run_Banksy = FALSE)
```

## Slide-seq v1/v2

### Data Requirements

Slide-seq data for Molo Pipeline must contain **raw_counts.csv.gz** and **spatial_info.csv.gz** files. We also support data in formats like .tsv.gz and .txt.gz. Below is the file structure tree for example data:

```bash
slide_seq
├── raw_counts.csv.gz
└── spatial_info.csv.gz
```

### Example Data

Download public [Slide-seq data](https://singlecell.broadinstitute.org/single_cell/study/SCP354/slide-seq-study#study-summary) or [Slide-seq v2 data](https://singlecell.broadinstitute.org/single_cell/study/SCP815/sensitive-spatial-genome-wide-expression-profiling-at-cellular-resolution#study-download).

(Haven't had time to run v2 dataset yet)

### Standard Pipeline

```R
molo_obj <- create_molo("Slide-seq", folder_path = "./slide_seq")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "mouse",
                          plot_path = "./plots/slide_seq/",
                          labeled_ref = "./ref/mouse_brain.rds",
                          run_Banksy = FALSE)
```

## Vizgen MERFISH

### Data Requirements

Vizgen MERFISH data for Molo Pipeline must contain the **cell_by_gene.csv** file and **cell_boundaries** folder. The cell_boundaries folder should contain multiple **feature_data_*.hdf5** files. Below is the file structure tree for example data:

```bash
vizgen
├── cell_boundaries
│   ├── feature_data_0.hdf5
│   ├── feature_data_1.hdf5
│   ├── ...
│   └── feature_data_1225.hdf5
└── cell_by_gene.csv
```

### Example Data

Download public [Vizgen MERFISH data](https://console.cloud.google.com/storage/browser/public-datasets-vizgen-merfish).

### Standard Pipeline

```R
molo_obj <- create_molo("MERFISH", folder_path = "./merfish")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "mouse",
                          plot_path = "./plots/vizgen/",
                          labeled_ref = "./ref/mouse_brain.rds",
                          run_Banksy = FALSE)
```

## Nanostring CosMx

### Data Requirements

Slide-seq v2 data for Molo Pipeline requires several files. Below is the file structure tree for example data:

```bash
cosmx
├── Run5642_S3_Quarter_exprMat_file.csv
├── Run5642_S3_Quarter_fov_positions_file.csv
├── Run5642_S3_Quarter_metadata_file.csv
├── Run5642_S3_Quarter-polygons.csv
└── Run5642_S3_Quarter_tx_file.csv
```

### Example Data

Download public [nanostring CosMx data](https://nanostring.com/products/cosmx-spatial-molecular-imager/ffpe-dataset/nsclc-ffpe-dataset/).

### Standard Pipeline

```R
molo_obj <- create_molo("CosMx", folder_path = "./cosmx")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "human",
                          plot_path = "./plots/cosmx/",
                          labeled_ref = NULL,
                          run_Banksy = FALSE)
```

## 10X Xenium

### Data Requirements

Refer to example data.

### Example Data

Download public [10X Xenium data](https://www.10xgenomics.com/datasets/fresh-frozen-mouse-brain-for-xenium-explorer-demo-1-standard).

### Standard Pipeline

```R
molo_obj <- create_molo("Xenium", folder_path = "./xenium")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "mouse",
                          plot_path = "./plots/xenium/",
                          labeled_ref = "./ref/mouse_brain.rds",
                          run_Banksy = FALSE)
```

## spatial ATAC-seq

### Preprocessing

1) Download SRA data from NCBI and decompress;

2) Fill in config.yaml as instructed. Do NOT modify any files except config.yaml;

3) Run `snakemake --configfile config.yaml` in terminal;

4) Check fragments.tsv.gz and other output files in specified directory.

> *Note: During preprocessing, you need to install CellRanger ATAC independently and fill in the installation path in config.yaml as prompted.*

### Data Requirements

Slide-seq v2 data for Molo Pipeline must contain **fragments.tsv.gz** and **spatial** folder. The spatial folder should include **scalefactors_json.json**, **tissue_lowres_image.png**, and **tissue_positions_list.csv**. Below is the file structure tree for example data:

```bash
sp_ATAC
├── fragments.tsv.gz
└── spatial
    ├── scalefactors_json.json
    ├── tissue_lowres_image.png
    └── tissue_positions_list.csv
```

### Example Data

Download public [spatial ATAC-seq data](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSM6043256).

### Standard Pipeline

```R
molo_obj <- create_molo("ATAC", folder_path = "./atac", ATAC_dataset = "mouse")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "mouse",
                          plot_path = "./plots/atac/",
                          labeled_ref = "./ref/mouse_brain.rds",
                          run_Banksy = FALSE)
```

## CODEX

### Data Requirements

Refer to example data.

### Example Data

Download public [Akoya CODEX data](https://app.globus.org/file-manager?origin_id=af603d86-eab9-4eec-bb1d-9d26556741bb&origin_path=%2Fc95d9373d698faf60a66ffdc27499fe1%2Fdrv_CX_20-008_lymphnode_n10_reg001%2Fprocessed_2020-12-2320-008LNn10r001%2Fsegm%2Fsegm-1%2Ffcs%2Fcompensated%2F&two_pane=false). Here is the [data description](https://portal.hubmapconsortium.org/browse/dataset/c95d9373d698faf60a66ffdc27499fe1).

### Standard Pipeline

```R
molo_obj <- create_molo("CODEX", folder_path = "./codex")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "human",
                          plot_path = "./plots/codex/",
                          labeled_ref = NULL,
                          run_Banksy = FALSE)
```

## Stereo-seq

### Data Requirements

Refer to example data.

### Example Data

Download public [Stereo-seq data](https://db.cngb.org/stomics/mosta/download/).

### Standard Pipeline

```R
molo_obj <- create_molo("Stereo-seq", folder_path = "./stereo_seq/")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "mouse",
                          plot_path = "./plots/stereo_seq/",
                          labeled_ref = NULL,
                          run_Banksy = FALSE)
```

## Custom

### Data Requirements

Custom data for Molo Pipeline must contain matrix.parquet with optional components. Below is the file structure tree for example data:

```bash
custom
├── matrix.parquet
├── embedding.parquet(optional)
├── umap.parquet(optional)
├── meta.csv(optional)
└── spatial.csv(optional)
```

> *Note: Given the typically large size of matrix and embedding data, we use parquet format instead of traditional CSV for better I/O efficiency. You can create parquet files using the arrow package in R or pandas.to_parquet(engine='pyarrow') in Python.*

### Example Data

Download [Custom data](https://drive.google.com/drive/folders/1xYrmMoqu8PElGAFYTIyL4CDseVGirCmW?usp=drive_link) generated from DLPFC dataset.

### Standard Pipeline

```R
molo_obj <- create_molo("Custom", folder_path = "./custom/")

molo_obj <- Molo_Pipeline(molo_obj,
                          nCount_range = c(10,2000),
                          nFeature_range = c(10,2000),
                          dataset = "mouse",
                          plot_path = "./plots/custom/",
                          labeled_ref = NULL,
                          run_Banksy = FALSE)
```
